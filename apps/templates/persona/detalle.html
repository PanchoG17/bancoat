{% extends 'layouts/base2.html' %}

{% block stylesheets %}
    <link type="text/css" href="{{ ASSETS_ROOT }}/css/custom.css" rel="stylesheet">
{% endblock stylesheets %}

{% block title %}{{title}}{% endblock %}

{% block content %}

    <h5 class="py-3 my-3">{{title}}:</h5>

    <div class="card my-3 shadow-table">

      <nav class="nav nav-tabs bg-gris justify-content-between">
        <div class="nav nav-tabs" id="nav-personales-tabs" role="tablist">
          <button class="nav-link active" id="nav-datos-personales-tab" data-bs-toggle="tab" data-bs-target="#nav-datos-personales" type="button" role="tab">Datos personales</button>
          <button class="nav-link" id="nav-direccion-tab" data-bs-toggle="tab" data-bs-target="#nav-direccion" type="button" role="tab">Dirección</button>
          <button class="nav-link" id="nav-contacto-tab" data-bs-toggle="tab" data-bs-target="#nav-contacto" type="button" role="tab">Contacto</button>
          {% if prestamos %}<button class="nav-link" id="nav-prestamos-tab" data-bs-toggle="tab" data-bs-target="#nav-prestamos" type="button" role="tab">Préstamos</button>{% endif %}
        </div>

        <div class="p-3 my-auto">
          <button type="button" id="editar-btn" class="btn border-success success-hover text-success py-1 px-3 me-2">Editar</button>
          <button type="button" id="guardar-btn" hidden class="btn border-success success-hover text-success py-1 px-3 me-2">Guardar</button>
          <button type="button" data-bs-toggle="modal" data-bs-target="#bajaModal" class="btn border-danger danger-hover text-danger py-1 px-3">Baja</button>
        </div>

      </nav>

      <form method="post" id="edit-form">
        <div class="card-body tab-content" id="nav-tabPersonales">

            {% csrf_token %}

            <div class="tab-pane fade show active" id="nav-datos-personales" role="tabpanel" aria-labelledby="nav-datos-personales">

              <div class="row mb-3 align-items-end">

                {{form.usuario_creador}}
                {{form.usuario_modificacion}}

                <div class="form-group col-sm">
                  {{form.nombre.errors}}
                  {{form.nombre.label_tag}}
                  {{form.nombre}}
                </div>
                <div class="form-group col-sm">
                  {{form.apellido.errors}}
                  {{form.apellido.label_tag}}
                  {{form.apellido}}
                </div>
                <div class="form-group col-sm">
                  {{form.fecha_nacimiento.errors}}
                  {{form.fecha_nacimiento.label_tag}}
                  {{form.fecha_nacimiento}}
                </div>
              </div>

              <div class="row mb-3 align-items-end">
                <div class="form-group col-sm">
                  {{form.documento_tipo.errors}}
                  {{form.documento_tipo.label_tag}}
                  {{form.documento_tipo}}
                </div>
                <div class="form-group col-sm">
                  {{form.documento.errors}}
                  {{form.documento.label_tag}}
                  {{form.documento}}
                </div>
                <div class="form-group col-sm">
                  {{form.cuit.errors}}
                  {{form.cuit.label_tag}}
                  {{form.cuit}}
                </div>
              </div>

              <div class="row mb-3 align-items-end">
                <div class="form-group col-sm">
                  {{form.nacionalidad.errors}}
                  {{form.nacionalidad.label_tag}}
                  {{form.nacionalidad}}
                </div>
                <div class="form-group col-sm">
                  {{form.estado_civil.errors}}
                  {{form.estado_civil.label_tag}}
                  {{form.estado_civil}}
                </div>
                <div class="form-group col-sm">
                  {{form.genero.errors}}
                  {{form.genero.label_tag}}
                  {{form.genero}}
                </div>
              </div>
            </div>

            <div class="tab-pane fade" id="nav-direccion" role="tabpanel" aria-labelledby="nav-direccion">

              <div class="row mb-3 align-items-end">
                <div class="form-group col-sm">
                  {{form.provincia.errors}}
                  {{form.provincia.label_tag}}
                  {{form.provincia}}
                </div>
                <div class="form-group col-sm">
                  {{form.localidad.errors}}
                  {{form.localidad.label_tag}}
                  {{form.localidad}}
                </div>
                <div class="form-group col-sm">
                  {{form.tipo_vivienda.errors}}
                  {{form.tipo_vivienda.label_tag}}
                  {{form.tipo_vivienda}}
                </div>
              </div>

              <div class="row mb-3 align-items-end">
                <div class="form-group col-sm">
                  {{form.zona.errors}}
                  {{form.zona.label_tag}}
                  {{form.zona}}
                </div>
                <div class="form-group col-sm">
                  {{form.barrio.errors}}
                  {{form.barrio.label_tag}}
                  {{form.barrio}}
                </div>
              </div>
              <div class="row mb-3 align-items-end">
                <div class="form-group col-sm">
                  {{form.calle.errors}}
                  {{form.calle.label_tag}}
                  {{form.calle}}
                </div>
                <div class="form-group col-sm">
                  {{form.numero.errors}}
                  {{form.numero.label_tag}}
                  {{form.numero}}
                </div>
                <div class="form-group col-sm">
                  {{form.numero_departamento.errors}}
                  {{form.numero_departamento.label_tag}}
                  {{form.numero_departamento}}
                </div>
              </div>

              <div class="row mb-3 align-items-end">
                <div class="form-group col-sm">
                  {{form.tira.errors}}
                  {{form.tira.label_tag}}
                  {{form.tira}}
                </div>
                <div class="form-group col-sm">
                  {{form.numero_piso.errors}}
                  {{form.numero_piso.label_tag}}
                  {{form.numero_piso}}
                </div>
              </div>

              <div class="row mb-3 align-items-end">
                <div class="form-group col-sm">
                  {{form.lote.errors}}
                  {{form.lote.label_tag}}
                  {{form.lote}}
                </div>
                <div class="form-group col-sm">
                  {{form.macizo.errors}}
                  {{form.macizo.label_tag}}
                  {{form.macizo}}
                </div>
                <div class="form-group col-sm">
                  {{form.manzana.errors}}
                  {{form.manzana.label_tag}}
                  {{form.manzana}}
                </div>
                <div class="form-group col-sm">
                  {{form.parcela.errors}}
                  {{form.parcela.label_tag}}
                  {{form.parcela}}
                </div>
                <div class="form-group col-sm">
                  {{form.seccion.errors}}
                  {{form.seccion.label_tag}}
                  {{form.seccion}}
                </div>
              </div>

            </div>

            <div class="tab-pane fade" id="nav-contacto" role="tabpanel" aria-labelledby="nav-contacto">
              <div class="row mb-3 align-items-end">
                <div class="form-group col-sm-2">
                  {{form.codigo_area_c.errors}}
                  {{form.codigo_area_c.label_tag}}
                  {{form.codigo_area_c}}
                </div>
                <div class="form-group col-sm">
                  {{form.numero_telefono_c.errors}}
                  {{form.numero_telefono_c.label_tag}}
                  {{form.numero_telefono_c}}
                </div>
                <div class="form-group col-sm-2">
                  {{form.codigo_area_f.errors}}
                  {{form.codigo_area_f.label_tag}}
                  {{form.codigo_area_f}}
                </div>
                <div class="form-group col-sm">
                  {{form.numero_telefono_f.errors}}
                  {{form.numero_telefono_f.label_tag}}
                  {{form.numero_telefono_f}}
                </div>
              </div>

              <div class="row mb-3 align-items-end">
                <div class="form-group col-sm">
                  {{form.email.errors}}
                  {{form.email.label_tag}}
                  {{form.email}}
                </div>
              </div>

            </div>

            <input type="submit" hidden id="submit-btn">

          <div class="tab-pane fade" id="nav-prestamos" role="tabpanel" aria-labelledby="nav-prestamos">

            <div class="row mb-3">

              <div class="table-responsive">

                <table class="table table-striped table-responsive table-p">
                    <thead>
                      <tr class="text-center">
                        <th scope="col" class="px-0">Comprobante</th>
                        <th scope="col" class="px-0">Producto</th>
                        <th scope="col" class="px-0">Fecha de otorgamiento</th>
                        <th scope="col" class="px-0">Fecha de devolución pactada</th>
                        <th scope="col" class="px-0">Regresado</th>
                        <th scope="col" class="px-0">Tiempo restante</th>
                        <th scope="col" class="px-0">Extender</th>
                      </tr>
                    </thead>
                    <tbody>

                        {% for p in prestamos %}
                            <tr class="text-center align-middle">
                                <td class="px-0">{{p.comprobante}}</td>
                                <td class="px-0">{{p.producto}}</td>
                                <td class="px-0">{{p.fecha_otorgamiento|date:"d M, Y"}}</td>
                                <td class="px-0">{{p.fecha_devolucion|date:"d M, Y"}}</td>
                                <td class="px-0">
                                  {% if p.regresado %}<i class="fa-solid fa-check text-success"></i>{% else %}<i class="fa-solid fa-xmark text-danger"></i>{% endif %}
                                </td>
                                <td class="fw-bold px-0 {% if p.restante.days < 7 %}text-danger{% elif p.restante.days < 30 %} text-warning{% else %}text-success {% endif %}">
                                  {% if p.regresado %} - {% else %} {{p.restante.days}} días {% endif %}
                                </td>
                                <td class="text-center">
                                  {% if p.regresado %}<button disabled class="btn text-success"> - </button> {% else %}
                                  <button class="btn btn-renovar text-success" data-whatever="{{p.pk}}" data-bs-toggle="modal" data-bs-target="#prestamosModal" type="button" title="Extender préstamo">
                                      <i class="fa-solid fa-plus"></i>
                                  </button>
                                  {% endif %}
                              </td>
                            </tr>
                        {% empty %}
                            <tr style="line-height: 4rem;">
                                <td colspan="9" class="text-center">Sin resultados</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </form>
    </div>

    <div class="modal fade" id="prestamosModal" tabindex="-1" role="dialog" aria-labelledby="prestamosModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header bg-gris">
              <h5 class="modal-title" id="prestamosModalLabel">Extender préstamo</h5>
            </div>
            <form method="POST" action="{% url 'inventario:renovar_comprobante' %}">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.path }}">

                <div class="modal-body">

                    <input type="hidden" name="id" id="idInput">

                    <div class="form-group mx-auto mb-3">
                        <label for="cteInput">Comprobante</label>
                        <input type="text" class="form-control" id="cteInput" disabled value="Comprobante">
                    </div>
                    <div class="form-group mx-auto my-3">
                        <label for="prdInput">Producto</label>
                        <input type="text" class="form-control" id="prdInput" disabled value="Producto">
                    </div>
                    <div class="form-group mx-auto my-3">
                        <label for="vtoInput">Fecha de vencimiento</label>
                        <input type="text" class="form-control" id="vtoInput" disabled value="Vencimiento">
                    </div>
                    <div class="form-group mx-auto my-3">
                        <label for="rteInput">Tiempo restante</label>
                        <input type="text" class="form-control" id="rteInput" disabled value="Tiempo restante">
                    </div>

                    <div class="form-group mx-auto my-3">
                        <label for="vto2Input">Nuevo vencimiento</label>
                        <input type="date" name="nuevo_vto" required class="form-control form-color" id="vto2Input">
                    </div>

                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn border-danger text-danger" data-bs-dismiss="modal">Cancelar</button>
                    <input type="submit" name="confirmar" value="Confirmar" class="btn btn-success text-white">
                </div>
            </form>

          </div>
        </div>
    </div>

    <div class="modal fade" id="bajaModal" tabindex="-1" role="dialog" aria-labelledby="bajaModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header bg-gris">
            <h5 class="modal-title" id="bajaModalLabel">Dar de baja una persona</h5>
          </div>
          <form method="POST" action="{% url 'persona:baja_persona' %}">
              {% csrf_token %}
              <input type="hidden" name="id" value="{{object.pk}}">
              <div class="modal-body pb-0">
                {{baja_form.as_p}}
                <p class="text-danger text-center my-4 fw-bold">Atención: esta acción es irreversible</p>
              </div>
              <div class="modal-footer justify-content-between">
                  <button type="button" class="btn border-danger text-danger" data-bs-dismiss="modal">Cancelar</button>
                  <input type="submit" name="confirmar" value="Confirmar" class="btn btn-success text-white">
              </div>
          </form>
      </div>
    </div>
  </div>

{% endblock content %}

{% block javascripts %}
<script>
    $(document).ready(()=>{

        $('#prestamosModal').on('show.bs.modal', function (event) {
            $('.modal-body input').val(' - ')

            var button = $(event.relatedTarget) // Button that triggered the modal
            var id = button.data('whatever') // Extract info from data-* attributes

            $.post( '/inventario/comprobantes/renovar', { id : id, csrfmiddlewaretoken: '{{ csrf_token }}' }
            )
            .done(function( data ) {

                $('#idInput').val(id)
                $('#cteInput').val(data['obj']['cte'])
                $('#prdInput').val(data['obj']['prd'])
                $('#vtoInput').val(data['obj']['vto'])
                $('#rteInput').val(data['obj']['rte'] + ' días')

            })
            .fail(function() {
                alert( "server error" );
            })

        })

        $('#editar-btn').on('click', function(event){
          $(this).attr('hidden', true)
          $('#edit-form input, #edit-form select').prop('disabled', false);
          $('#guardar-btn').removeAttr('hidden');
        })

        $('#guardar-btn').on('click', function(event){
          $(this).attr('hidden', true)
          $('#submit-btn').click();
          $('#editar-btn').removeAttr('hidden');
          $('#edit-form input, #edit-form select').prop('disabled', true);
        })

    });

</script>
{% endblock javascripts %}